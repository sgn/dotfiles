#!/bin/bash

# https://stackoverflow.com/a/15859646/4115625
# NB: Assumes that ~user does not expand to a name with double spaces or
#     tabs or newlines, etc.
expand_tilde()
{
    case "$1" in
    (\~)        echo "$HOME";;
    (\~/*)      echo "$HOME/${1#\~/}";;
    (\~[^/]*/*) local user
		user=$(eval echo "${1%%/*}")
                echo "$user/${1#*/}";;
    (\~[^/]*)   eval echo "${1}";;
    (*)         echo "$1";;
    esac
}

mbsync="$HOME/.cache/mbsync"
gnus="$HOME/.cache/mail"
if test -n "$1" && test -d "$1"; then
	mbsync=$(expand_tilde "$1")
fi

if test -n "$2" ; then
	gnus=$(expand_tilde "$2")
fi

if ! test -d "$mbsync" ; then
	echo "Error: '$mbsync' is not a directory."
	echo "Run mbsync and/or correct the path."
	exit 1
fi

find "$mbsync" -name cur -print0 \
	| while read -r -d $'\0' cur ; do
	ln_src=$(dirname "$cur")
	
	if test -d "$ln_src/new" && test -d "$ln_src/tmp" ; then
		ln_dst="${ln_src/#$mbsync/$gnus}"
		ln_dst=$(sed -e 's%/\[Gmail\]/Drafts%/drafts%' \
			     -e 's%/Drafts%/drafts%' \
			     -e 's%/\[Gmail\]/Sent Mail%/sent%' \
			     -e 's%/Outbox%/sent%' \
			     -e 's%/\[Gmail\]/Spam%/spam%' \
			     -e 's%/Junk%/spam%' \
			     -e 's%/\[Gmail\]/Trash%/trash%' \
			     -e 's%/Deleted%/trash%' \
		      <<< "$ln_dst" )
		mkdir -p "$ln_dst"
		ln -sf "$ln_src/cur" "$ln_dst/cur"
		ln -sf "$ln_src/new" "$ln_dst/new"
		ln -sf "$ln_src/tmp" "$ln_dst/tmp"
	fi
	done
