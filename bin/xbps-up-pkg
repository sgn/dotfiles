#!/bin/sh

PKGS=$(cat <<-__EOF__
	bluez
	dracut
	efitools
	fcitx-unikey
	firefox-esr
	git
	libtimezonemap
	nspr
	nss
	python3-Sphinx
	python3-authres
	python3-elementpath
	python3-fido2
	python3-scard
	python3-sphinxcontrib-applehelp
	python3-sphinxcontrib-devhelp
	python3-sphinxcontrib-htmlhelp
	python3-sphinxcontrib-jsmath
	python3-sphinxcontrib-qthelp
	python3-sphinxcontrib-serializinghtml
	python3-usb
	python3-xmlschema
	sbsigntool
	yubikey-manager
	__EOF__
)

CHROOT_PKGS=":$(tr '\n' ':' <<-__EOF__
	git
	__EOF__
)"

update_pkg() {
	c_flags=$1
	pkg=$2
	version=$3
	sed -i -e "/^version/s/=.*/=$version/" \
		-e "/^revision=/s/=.*/=1/" \
		"srcpkgs/$pkg/template"
	xgensum $c_flags -i "srcpkgs/$pkg/template"
	xbump "$pkg"
}

cd "$(xdistdir)" || exit

for pkg in $PKGS; do
	c_flags=""
	version=$(./xbps-src update-check "$pkg" |
		sed "s/.*-> $pkg-//" |
		sort -V | tail -1)
	if [ -n "$version" ]; then
		if grep -q "^checksum=['\"]?@" "srcpkgs/$pkg/template"; then
			c_flags="-c"
		elif grep -A 1 "^checksum=['\"]?$" "srcpkgs/$pkg/template" |
			grep -q "@"; then
			c_flags="-c"
		fi
		update_pkg "$c_flags" "$pkg" "$version"
		case "$CHROOT_PKGS" in
		*:$pkg:*) update_pkg "$c_flags" "chroot-$pkg" "$version" ;;
		esac
	fi
done
